\documentclass{article}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage[czech]{babel}
\usepackage{csquotes}
\usepackage{tabularx}

\title{IMP - Řízení spotřeby energie mikrokontroléru}
\author{Martin Slezák (xsleza26)}
\date{\today}

\begin{document}

\maketitle

\newpage

\tableofcontents

\newpage

\section{Úvod}

Tento projekt řeší řízení spotřeby energie mikrokontroléru, konkrétně na
mikrokontroléru FITkit3. Tento mikrokontrolér podporuje několik způsobů, jak
řídit spotřebu. V tomto projektu je popsáno, proč se spotřeba na
mikrokontroléru řídí a jak jednotlivé způsoby úspory energie fungují. Nakonec
na základě některých z těchto prostředků byla sestavena vestavěná aplikace.

\section{Proč řídit spotřebu}

Téměř v každé domácnosti se vyskytuje desítky mikrokontrolérů, které se mohou
vyskytovat například v pračce, lednici ale i v dalších mnoha zařízeních.

Mikrokontrolér v mnoha případech pouze čeká a samotná činnost se vykoná až
například po stisku klávesy nebo jednou za čas. V takové chvíli je zbytečné,
aby mikrokontrolér běžel, jelikož stále využívá energie.

\subsection{Jádro mikrokontroléru}

Jádro mikrokontroléru je nejvíce náročné na energii. Je tedy plýtváním energie
nechat jádro běžet zbytečně a nebo naopak moc rychle. V případě, že jádro čeká
na nějakou událost, se jádro uspí. Jakmile daná událost nastane, je jádro
probuzeno například přerušením (asynchronní) a nebo po uplynutí daného času
(synchronní).

Je však třeba najít ideální rychlost jádra. Moc velká frekvence jádra způsobí
větší spotřebu jádra, avšak akce bude dokončena rychleji a jádro lze poté
uspat, zatímco menší frekvence způsobí menší spotřebu, ale akce bude trvat
déle.

\subsection{Paměť}

Existují různé druhy paměti. Tyto paměti poté mají i různou spotřebu energie a
různou rychlost čtení či zápisu. Na základě těchto faktorů je vhodné zvolit
paměť, která nám bude dostačovat pro řešení našeho problému a bude mít možná co
nejmenší spotřebu. Například paměť RAM má menší spotřebu než paměť Flash. Tyto
rozdíly jsou však téměř zanedbatelné.

\subsection{Periferie}

Některé periferie nemusí být v aplikaci použiti, je proto vhodné vypnout jejich
hodinový signál, čímž periferii vypneme. V opačném případě, že periferii lze
použít pro řešení problému aplikace, je vhodné tuto periferii použít. Jak již
bylo zmíněno, jádro je nejvíce náročné na energie a je tedy vhodné
minimalizovat práci jádra.

\section{Klíčové pojmy}

TODO

\section{Řízení spotřeby}

Mikrokontrolér obsahuje řadič správy napájení, který nabízí různé možnosti, jak
řídit spotřebu energie. Tato úspora je na základě požadované úrovně funkčnosti,
například zda je třeba zachovávat stav mikrokontroléru, případně vypnutí
logických obvodů. Stavy I/O (vstupy a výstupy) jsou však zachovány ve všech
režimech.

Na základě těchto nároků je zvolen jeden z existujících režimů. Tyto režimy
jsou děleny na základě ůrovně spotřeby, kdy agresivnější režimy omezí více
funkcionality.

Existují tři hlavní režimy činnosti: běhový (run), čekací (wait), zastavovací
(stop). Pomocí instrukce WFI (Wait For Interrupt) se čip přepne do čekacího
nebo zastavovacího režimu.

Pro každý běhový (run) režim existují odpovídající čekací (wait) a zastavovací
(stop) režimy. Čekací (wait) režim se podobá režimu spánku procesorů ARM.
Zastavovací (stop) jsou podobné hlubokému spánku ARM procesorů.

Existuje také režim velmi nízkého výkonu (VLPR), který umožňuje výrazně snížit
spotřebu během provozu v případě, že aplikace nepotřebuje maximální frekvenci
sběrnice.

\subsection{Normální režim}

\begin{tabularx}{\textwidth}{|>{\centering\arraybackslash}p{0.09\textwidth}|X|}
    \hline
    \textbf{Režim} & \textbf{Popis} \\
    \hline
    Run & Maximální výkon čipu. Defaultní režim po resetu. Zapnutý regulátor
    napětí \\
    \hline
    Wait & Jádro je uspané, periferie fungují. NVIC zůstává citlivý na
    přerušení \\
    \hline
    Stop & Čip v statickém stavu. Režim nejnižší spotřeby zachovávající stavy
    všech registrů. NVIC je zakázán, AWIC k probuzení z přerušení. Periferie
    nefungují \\
    \hline
\end{tabularx}

\subsection{Režim velmi nízkého výkonu}

\begin{tabularx}{\textwidth}{|>{\centering\arraybackslash}p{0.09\textwidth}|X|}
    \hline
    \textbf{Režim} & \textbf{Popis} \\
    \hline
    Run & Regulátor napětí v režimu nízké spotřeby (dostatek energie pro
    provoz při snížené frekvenci). Snížená frekvence režimu přístupu Flash.
    LVD vypnuto. Interní oscilátor poskytuje nízkovýkonový 4 MHz zdroj pro
    jádro, sběrnici a také periferie \\
    \hline
    Wait & Stejné jako run s jádrem v režimu spánku \\
    \hline
    Stop & Čip v statickém stavu, vypnutý provoz LVD. Režim nejnižší spotřeby
    ADC a funkčním přerušením pinů. Periferie nefungují, lze využít RTC,
    CMP,... NVIC je zakázán, AWIC k probuzení z přerušení. \\
    \hline
\end{tabularx}

\subsection{Low Leakage a Very Low Leakage}

\begin{tabularx}{\textwidth}{|>{\centering\arraybackslash}p{0.13\textwidth}|X|}
    \hline
    \textbf{Režim} & \textbf{Popis} \\
    \hline
    Low Leakage Stop & Stav zachování režimu napájení. Většina periferií v
    režimu zachování stavu (zastavené hodiny). NVIC zakázáno. LLWU k probuzení.
    \\
    \hline
    Very Low Leakage Stop3 & Většina periferií deaktivována. NVIC zakázáno.
    LLWU k probuzení. SRAM\_U a SRAM\_L zapnuté (obsah zachován) \\
    \hline
    Very Low Leakage Stop2 & Většina periferií deaktivována. NVIC zakázáno.
    LLWU k probuzení. SRAM\_L vypnutý. Část SRAM\_U zapnutá (obsah zachován). \\
    \hline
    Very Low Leakage Stop1 & Většina periferií deaktivována. NVIC zakázáno.
    LLWU k probuzení. Všechny SRAM\_U a SRAM\_L jsou vypnuté 32B soubor
    systémového registru a 32B soubor registru VBAT napájeny (data kritická
    pro zákazníky) \\
    \hline
\end{tabularx}

\newpage

\section{Přechody mezi režimy}

Přechody mezi režimy hezky znázorňuje následující stavový diagram. Z diagramu
lze vidět, že po resetu je mikrokontrolér v režimu Run, ze kterého poté může
přecházet do jednotlivých režimů. Navíc jsou ještě přechody mezi stavem Very
Low Power Run a jeho odpovídajícími Wait a Stop režimy. Z režimu VLPR lze také
přejít do režimů Very Low Leakage StopN (VLLS3, VLLS2, VLLS1) a Low Leakage
Stop (LLS).

\includegraphics[width=1.0\textwidth]{power-modes.png}

Pro přechod do jiného režimu se využívá instrukce \texttt{WFI}, která se z C
programu volá pomocí funkce \texttt{__WFI()}. Na základě nastavených hodnot
se přepne do odpovídajícího režimu.

\end{document}
